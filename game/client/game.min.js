'use strict';const Game=(()=>{function a(a){const b=new Error(a);return b.withMessage=!0,b}function b(){function a(a,c){return a+(c-a)*b}let b=(performance.now()-P)/Q;0>b&&(b=0),1<b&&(b=1),I=a(R,V),J=a(S,W),M=a(T,X),N=a(U,Y)}function c(){z.fillStyle="#2e2e2e",z.fillRect(0,0,F,G),z.save(),z.setTransform($),z.clip(E),z.fillStyle="black",z.fillRect(-s/2,-20,s,r),z.fillStyle="white";for(let a=0;a<Math.floor(20);a++)0==a%6&&(z.fillRect(-.1,-3-a-1,.2,1),z.fillRect(-.1,3+a,.2,1));z.fillRect(I-.5,J-.5,1,1),z.fillRect(-s/2,M-4,1,t),z.fillRect(s/2-1,N-4,1,t),(H===j||H===k)&&(d(K,-s/2+8,-3.75,1.5,!1),d(L,s/2-8,-3.75,1.5,!0)),z.restore()}function d(a,b,c,d,e){if(!Number.isInteger(a)||0>a)return;let f=[];do f.push(x[a%10]),a=~~(a/10);while(0!=a);f.reverse(),e&&(b-=(6*f.length-1)*d);const g=1.05*d;for(let h of f){for(let a=0;5>a;a++)for(let e=0;5>e;e++)0!=(1&h)&&z.fillRect(b+e*d,c+a*d,g,g),h>>=1;b+=6*d}}function e(){if(Z===m||Z===n){if(y.clientWidth!==F||y.clientHeight!==G){F=y.width=y.clientWidth,G=y.height=y.clientHeight;const a=F/G;$.a=a>q?$.d=G/r:$.d=F/(r*q),$.e=F/2,$.f=G/2,E=new Path2D,E.rect(-s/2,-20,s,r)}if(b(),c(),Z===m){Z=n;try{i.onRunning&&i.onRunning()}catch{}}Z===n&&requestAnimationFrame(e)}}function f(a,b){const c=w[a.key];void 0===c||(b?B|=c:B&=~c)}function g(a){const b=new DataView(a.data),c=b.getUint8(0);R=V,S=W,T=X,U=Y,O=P,P=performance.now();for(let d=1,e=0;8>e;e++)0!=(c&1<<e)&&(0===e?H=b.getUint8(d++):1===e?(V=b.getFloat32(d+0,!0),W=b.getFloat32(d+4,!0),d+=8):2===e?K=b.getUint8(d++):3===e?L=b.getUint8(d++):4===e?(X=b.getFloat32(d,!0),d+=4):5===e?(Y=b.getFloat32(d,!0),d+=4):void 0);if(64&c&&(R=V,S=W),null!==O&&null!==P){const a=P-O;null===Q?(Q=a,null!==D&&(D(),D=null)):Q=(Q+a)/2}if(B!==C&&(A.send(new Uint8Array([B])),C=B),Z===n&&H===k){try{A.close()}catch{}removeEventListener("keyup",_),removeEventListener("keydown",aa),Z=o;try{i.onFinish&&i.onFinish(K,L)}catch{}}}function h(){if(Z===m||Z===n){removeEventListener("keyup",_),removeEventListener("keydown",aa),Z=p;try{i.onError&&i.onError("Connection to server was lost")}catch{}}}const i={onLoading:null,onRunning:null,onFinish:null,onError:null,start:async(b,c,d)=>{if(Z!==l&&Z!==o&&Z!==p)throw a("Attempt to start game multiple times");Z=m;try{i.onLoading&&i.onLoading()}catch{}try{if("https:"!==location.protocol&&"http:"!==location.protocol)throw a("Unsupported protocol");let f=location.protocol.replace("http","ws").concat("//",c,"/game",...d.map((a,b)=>`${0===b?"?":"&"}with_token=${a}`));if(y=b,z=b.getContext("2d"),null===z||void 0===z)throw a("Unable to get 2D drawing context");if(B=0,C=0,D=null,O=null,P=null,Q=null,await new Promise((b,c)=>{const d=setTimeout(()=>{c(a("Timeout during connection attempt"));try{A.close()}catch{}},2500);A=new WebSocket(f),A.binaryType="arraybuffer",A.onmessage=a=>{clearTimeout(d),b(A),g(a)},A.onclose=()=>{clearTimeout(d),c(a("Unable to connect to server"))}}),A.onmessage=g,A.onclose=null,await new Promise((b,c)=>{const d=setTimeout(()=>{A.onmessage=null,A.onclose=null;try{A.close()}catch{}c(a("Server is not responding"))},1e3);A.onclose=()=>{c(a("Connection to server was lost"))},D=()=>{clearTimeout(d),b()}}),H==k){Z=o;try{i.onFinish&&i.onFinish(K,L)}catch{}try{A.close()}catch{}}else A.onclose=h,addEventListener("keyup",_),addEventListener("keydown",aa),requestAnimationFrame(e)}catch(a){Z=p;try{a instanceof Error&&!0===a.withMessage?i.onError&&i.onError(a.message):i.onError&&i.onError("Unable to start game")}catch{}}}},j=2,k=3,l=0,m=1,n=2,o=3,p=4,q=4/3,r=40,s=r*q,t=8,u=1,v=2,w={w:u,s:v,ArrowUp:u,ArrowDown:v,o:4,l:8},x=[15324974,8661384,32584238,16267791,8682828,16268351,15252526,1118495,15252014,15235630];let y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z=l,$={b:0,c:0};const _=a=>f(a,!1),aa=a=>f(a,!0);return i})();
<div class="container">
    <h1>Game Sessions</h1>
    <button id="filter-btn" class="btn btn-primary">Show only my Game Sessions</button>
    <table  class="table table-striped table-hover"
            id="game_sessions-table"
            data-toggle="table"
            data-sortable="true"
            data-click-to-select="false">
        <thead>
            <tr>
                <th data-field="game_id" data-sortable="true">ID</th>
                <th data-field="date" data-sortable="true">Date</th>
                <th data-field="player1" data-sortable="true">Player 1</th>
                <th data-field="p1_wins" data-sortable="true">P1 Wins</th>
                <th data-field="player2" data-sortable="true">Player 2</th>
                <th data-field="p2_wins" data-sortable="true">P2 Wins</th>
                <th data-field="winner" data-sortable="true">Winner</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamically populated rows will go here -->
        </tbody>
    </table>
    <div id="chart-game_sessions" style="width: 100%; height: 400px; margin-top: 20px;"></div>
</div>

{% load static %}

<script type="text/javascript">
    var gameSessionData = JSON.parse('{{ game_sessions|escapejs }}');
    var currentUser = '{{ current_user|escapejs  }}';
    console.log('html_currentUser:', currentUser);

    populateTable(gameSessionData, '#game_sessions-table');

    // Prepare data for stepline chart
    // Aggregate games by date
    var gamesByDate = gameSessionData.reduce((acc, session) => {
        // Extract just the date part from the 'date' string
        let date = session.date.split(' ')[0];
        if (acc[date]) {
            acc[date] += 1;
        } else {
            acc[date] = 1;
        }
        return acc;
    }, {});

    // Transform data for ApexCharts
    var chartData = Object.entries(gamesByDate).map(([date, count]) => ({
        x: new Date(date).getTime(), // Convert date string to timestamp
        y: count
    }));

    // Sort data by date as ApexCharts expects data to be sorted for time series
    chartData.sort((a, b) => a.x - b.x);
    createGameSessionChart(chartData);

    document.getElementById('filter-btn').addEventListener('click', function() {
            filterTableByUser(currentUser);
        });
</script>